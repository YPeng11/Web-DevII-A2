<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Events</title>
    <link rel="stylesheet" href="css/css.css">
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">Love Charity</div>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="search.html">Search Event</a>
                    <a href="#">About Us</a>
                </div>
            </nav>
        </div>
    </header>


    <section class="section">
        <div class="container">
            <h2 class="section-title">Search Event</h2>

            <form class="search-form" id="searchForm">
                <div class="form-row">
                    <div class="form-field">
                        <label for="date"> Date</label>
                        <input type="date" id="date" name="date">
                    </div>

                    <div class="form-field">
                        <label for="location"> Location</label>
                        <input type="text" id="location" name="location" placeholder="Please Input City">
                    </div>

                    <div class="form-field">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <option value="">All Categories</option>
                            <!-- Categories will be loaded by api -->
                        </select>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn-secondary" id="clearFilters">Clear Filter</button>
                    <button type="submit" class="btn-primary">Search Event</button>
                </div>
            </form>

            <!-- errorMessage -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <!-- Search result -->
            <div class="results-container">
                <div class="results-header">
                    <div class="results-count" id="resultsCount">There are 0 Events</div>
                </div>

                <div id="resultsContent">
                    <!-- init -->
                    <div class="no-results">
                        <p>Search events using the filters above</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Contact us</h3>
                    <p>Tel: (123) 456-7890</p>
                    <p>Email: charity@charity.com</p>
                    <p>Address: No. 123 Charity Road, Liuzhou City, Guangxi Zhuang Autonomous Region</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="index.html" style="color: white;">Home</a><br>
                    <a href="search.html" style="color: white;">Search</a><br>
                </div>
                <div class="footer-section">
                    <h3>About Us</h3>
                    <p>A non-profit organization</p>
                    <p>Our mission is to convey love, create hope, and allow everyone to enjoy equal development
                        opportunities.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Love Charity.</p>
            </div>
        </div>
    </footer>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const categorySelect = document.getElementById('category');
            const searchForm = document.getElementById('searchForm');
            const clearFiltersBtn = document.getElementById('clearFilters');
            const errorMessage = document.getElementById('errorMessage');
            const resultsContent = document.getElementById('resultsContent');
            const resultsCount = document.getElementById('resultsCount');

            // 页面加载时获取类别选项
            loadCategories();

            // 表单提交事件
            searchForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // 获取表单数据
                const formData = new FormData(searchForm);
                const date = formData.get('date');
                const location = formData.get('location');
                const category = formData.get('category');

                // loading status
                resultsContent.innerHTML = '<div class="loading"> Searching...</div>';
                try {
                    // search args
                    const params = new URLSearchParams();
                    if (date) params.append('date', date);
                    if (location) params.append('location', location);
                    if (category) params.append('category_id', category);


                    const response = await fetch(`http://localhost:3060/api/events/search?${params}`);

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const events = await response.json();
                    displayResults(events);

                    //count
                    resultsCount.textContent = `There are ${events.length} Events`;

                    // error message
                    errorMessage.style.display = 'none';
                } catch (error) {
                    console.error('Search error:', error);
                    errorMessage.textContent = `Search error: ${error.message}`;
                    errorMessage.style.display = 'block';

                    //init
                    resultsContent.innerHTML = '';
                    resultsCount.textContent = 'There are 0 Events';
                }

            });

            // Clear filter
            clearFiltersBtn.addEventListener('click', function () {
                searchForm.reset();
                resultsContent.innerHTML = '<div class="no-results"><p>Search events using the filters above</p></div>';
                resultsCount.textContent = 'There are 0 Events';
                errorMessage.style.display = 'none';
            });

            async function loadCategories() {
                try {
                    const response = await fetch('http://localhost:3060/api/events/categories');
                    if (response.ok) {
                        const categories = await response.json();
                        populateCategorySelect(categories);
                    } else {
                        throw new Error(`Failed to load categories`);
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                    errorMessage.textContent = `Error loading categories`;
                    errorMessage.style.display = 'block';
                }
            }

            function populateCategorySelect(categories) {
                while (categorySelect.children.length > 1) {
                    categorySelect.removeChild(categorySelect.lastChild);
                }

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }


            // display results
            function displayResults(events) {
                if (events.length === 0) {
                    resultsContent.innerHTML = '<div class="no-results"><p>No matching events</p><p>Please try adjusting your search criteria</p></div>';
                    return;
                }

                let html = '<ul class="events-list">';

                events.forEach(event => {
                    const eventDate = new Date(event.date);
                    const formattedDate = `${eventDate.getFullYear()}/${eventDate.getMonth() + 1}/${eventDate.getDate()}`;

                    // status
                    const statusText = event.event_status === 1 ? "Ongoing" : "Past";
                    const statusClass = event.event_status === 1 ? "status-ongoing" : "status-past";

                    const completionRate = (event.price / event.target_price) * 100;

                    html += `
                        <li class="event-item">
                            <h3 class="event-name">${event.name}</h3>
                            <div class="event-meta">
                                <div class="event-meta-item">${formattedDate}</div>
                                <div class="event-meta-item">${event.location}</div>
                                <div class="event-meta-item"> ${event.category_name}</div>
                                <div class="event-meta-item">${event.organization_name}</div>
                            </div>
                            <p class="event-description">${event.detail}</p>
                            <div class="event-meta">
                                <div class="event-meta-item">
                                   Raised: $${event.price} / Target: $${event.target_price}
                                </div>
                                <div class="event-meta-item">
                                    Progress: ${completionRate.toFixed(1)}%
                                </div>
                                <div class="event-meta-item">
                                    <span class="event-status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="event-actions">
                                <a href="detail.html?id=${event.id}" >Detail</a>
                            </div>
                        </li>
                    `;
                });

                html += '</ul>';
                resultsContent.innerHTML = html;
            }
        });
    </script>
</body>

</html>